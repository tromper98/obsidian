#clickhouse 

Наследует функциональность [[MergeTree]] и добавляет в алгоритм слияния кусков данных  логику [[Сворачание строк|сворачивания (удаления) строк]].

**CollapsingMergeTree** асинхронно удаляет пары строк, если все поля в [[Ключ Сортировки|ключе сортировки]] эквиваленты, за исключением специального поля **Sign**, которое может принимать значения **1** или **-1**. Строки без пары сохраняются.

Движок может значительно уменьшить объём хранения и, как следствие, повысить эффективность запросов `SELECT`.

**CollapsingMergeTree** используется, когда нужно сохранять постоянно меняющиеся данные. Операция обновления является дорогостоящей и медленной для СУБД. Поэтому **CollapsingMergeTree** записывает новое состояние объекта с состоянием  **Sign = 1** . Предыдущее состояние объекта отменяется записью объекта с идентичными значениями в ключе сортировки и значением **Sign = -1**. 

Движок в фоновом режиме при слиянии данных сворачивает (удаляет) предыдущие состояния объекта, оставляя не более чем двух строк.  одна из которых имеет **Sign = 1** (строка состояния), а другая строка с **Sign = -1** (строка отмены состояния).

Для каждого результирующего куска данных ClickHouse сохраняет:

1.  Первую строку отмены состояния и последнюю строку состояния, если количество строк обоих видов совпадает и последняя строка — строка состояния.
2.  Последнюю строку состояния, если строк состояния на одну больше, чем строк отмены состояния.
3.  Первую строку отмены состояния, если их на одну больше, чем строк состояния.
4.  Ни одну из строк во всех остальных случаях.

## Особенности подхода

1.  Программа, которая записывает данные, должна помнить состояние объекта, чтобы иметь возможность отменить его. Строка отмены состояния должна содержать копию полей сортировочного ключа предыдущей строки состояния с противоположным значением `Sign`. Это увеличивает начальный размер хранилища, но позволяет быстро записывать данные.

2.  Длинные растущие массивы в Столбцах снижают эффективность работы движка за счёт нагрузки на запись. Чем проще данные, тем выше эффективность.

5.  Результаты запроса `SELECT` сильно зависят от согласованности истории изменений объекта. Будьте точны при подготовке данных для вставки. Можно получить непредсказуемые результаты для несогласованных данных, например отрицательные значения для неотрицательных метрик, таких как глубина сеанса.